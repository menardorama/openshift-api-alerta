#!/bin/bash

echo "Configuring alerta..."
cat <<EOF > ${OPENSHIFT_DATA_DIR}/alerta.conf
[DEFAULT]
timezone = Europe/London
log_dir = ${OPENSHIFT_PYTHON_LOG_DIR}
parser_dir = ${OPENSHIFT_DATA_DIR}
use_syslog = no

mongo_username = ${OPENSHIFT_MONGODB_DB_USERNAME}
mongo_password = ${OPENSHIFT_MONGODB_DB_PASSWORD}
mongo_database = ${OPENSHIFT_APP_NAME}
mongo_host = ${OPENSHIFT_MONGODB_DB_HOST}
mongo_port = ${OPENSHIFT_MONGODB_DB_PORT}

stomp_host = ${OPENSHIFT_PYTHON_IP}
stomp_port = 15000
inbound_queue = /queue/alerts

EOF

export ALERTA_CONF=${OPENSHIFT_DATA_DIR}/alerta.conf

echo "Installing STOMP message queue..."
pip install python-daemon
pip install coilmq

echo "Starting STOMP message queue..."
coilmq -b ${OPENSHIFT_PYTHON_IP} -p 15000 -d

echo "Starting alerta server daemon..."
alerta --pid-dir ${OPENSHIFT_TMP_DIR}
